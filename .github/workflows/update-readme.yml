name: ðŸ¤– Auto Update README

on:
  push:
    branches: [ main ]
    paths: 
      - 'exercicios/**'
      - 'desafios/**'
      - 'scripts/**'
  schedule:
    # Executa todo dia Ã s 6:00 UTC (3:00 BRT)
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'ForÃ§ar atualizaÃ§Ã£o completa'
        required: false
        default: 'false'

jobs:
  update-readme:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ðŸ“¦ Install Dependencies
      run: |
        npm ci || npm install

    - name: ðŸ” Detect Changes
      id: changes
      run: |
        if [ "${{ github.event.inputs.force_update }}" = "true" ]; then
          echo "has_changes=true" >> $GITHUB_OUTPUT
        else
          # Verifica se houve mudanÃ§as nos exercÃ­cios ou desafios
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | grep -E "(exercicios|desafios)/" || true)
          if [ -n "$CHANGED_FILES" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "MudanÃ§as detectadas em: $CHANGED_FILES"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "Nenhuma mudanÃ§a detectada nos exercÃ­cios/desafios"
          fi
        fi

    - name: ðŸš€ Update README
      if: steps.changes.outputs.has_changes == 'true'
      run: |
        echo "ðŸ”„ Executando atualizaÃ§Ã£o automÃ¡tica do README..."
        npm run update-readme

    - name: ðŸ”— Validate Links
      if: steps.changes.outputs.has_changes == 'true'
      run: |
        echo "ðŸ” Validando links do README..."
        npm run validate-links || echo "âš ï¸ Alguns links podem estar quebrados"

    - name: ðŸ“Š Generate Statistics
      if: steps.changes.outputs.has_changes == 'true'
      run: |
        echo "ðŸ“ˆ Gerando estatÃ­sticas do projeto..."
        
        # Conta exercÃ­cios
        EXERCISES_COUNT=$(find exercicios -name "ex*" -type d | wc -l)
        echo "ExercÃ­cios encontrados: $EXERCISES_COUNT"
        
        # Conta desafios
        CHALLENGES_COUNT=$(find desafios -name "d*" -type d | wc -l)
        echo "Desafios encontrados: $CHALLENGES_COUNT"
        
        # Salva estatÃ­sticas
        echo "{\"exercises\": $EXERCISES_COUNT, \"challenges\": $CHALLENGES_COUNT, \"total\": $((EXERCISES_COUNT + CHALLENGES_COUNT)), \"updated_at\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"}" > .github/stats.json

    - name: ðŸ·ï¸ Update Badges
      if: steps.changes.outputs.has_changes == 'true'
      run: |
        echo "ðŸ·ï¸ Atualizando badges dinÃ¢micos..."
        
        # LÃª estatÃ­sticas
        EXERCISES=$(cat .github/stats.json | grep -o '"exercises": [0-9]*' | grep -o '[0-9]*')
        CHALLENGES=$(cat .github/stats.json | grep -o '"challenges": [0-9]*' | grep -o '[0-9]*')
        
        # Atualiza badges no README
        sed -i "s/ExercÃ­cios-[0-9]*-blue/ExercÃ­cios-$EXERCISES-blue/g" README.md
        sed -i "s/Desafios-[0-9]*-red/Desafios-$CHALLENGES-red/g" README.md
        
        echo "âœ… Badges atualizados: $EXERCISES exercÃ­cios, $CHALLENGES desafios"

    - name: ðŸ“ Commit Changes
      if: steps.changes.outputs.has_changes == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Verifica se hÃ¡ mudanÃ§as para commitar
        if git diff --quiet; then
          echo "ðŸ“ Nenhuma mudanÃ§a para commitar"
        else
          git add README.md .github/stats.json .github/badges.json 2>/dev/null || true
          git commit -m "ðŸ¤– Auto-update: README, estatÃ­sticas e badges
          
          ðŸ“Š EstatÃ­sticas atualizadas:
          - ExercÃ­cios: $(cat .github/stats.json | grep -o '\"exercises\": [0-9]*' | grep -o '[0-9]*')
          - Desafios: $(cat .github/stats.json | grep -o '\"challenges\": [0-9]*' | grep -o '[0-9]*')
          - Atualizado em: $(date -u +%Y-%m-%d\ %H:%M:%S\ UTC)
          
          ðŸ”„ MudanÃ§as detectadas em: $(git diff --name-only HEAD~1 HEAD | grep -E '(exercicios|desafios)/' | tr '\n' ' ')
          
          ---
          *AtualizaÃ§Ã£o automÃ¡tica via GitHub Actions*"
          
          echo "âœ… MudanÃ§as commitadas com sucesso"
        fi

    - name: ðŸš€ Push Changes
      if: steps.changes.outputs.has_changes == 'true'
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: main

    - name: ðŸ“‹ Summary
      if: steps.changes.outputs.has_changes == 'true'
      run: |
        echo "## ðŸŽ‰ AtualizaÃ§Ã£o ConcluÃ­da!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š EstatÃ­sticas do Projeto" >> $GITHUB_STEP_SUMMARY
        echo "- **ExercÃ­cios:** $(cat .github/stats.json | grep -o '\"exercises\": [0-9]*' | grep -o '[0-9]*')" >> $GITHUB_STEP_SUMMARY
        echo "- **Desafios:** $(cat .github/stats.json | grep -o '\"challenges\": [0-9]*' | grep -o '[0-9]*')" >> $GITHUB_STEP_SUMMARY
        echo "- **Total:** $(cat .github/stats.json | grep -o '\"total\": [0-9]*' | grep -o '[0-9]*')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”— Links Ãšteis" >> $GITHUB_STEP_SUMMARY
        echo "- [ðŸ“– README Atualizado](https://github.com/${{ github.repository }}/blob/main/README.md)" >> $GITHUB_STEP_SUMMARY
        echo "- [ðŸŒ GitHub Pages](https://mateusoliveiradev1.github.io/html-css/)" >> $GITHUB_STEP_SUMMARY
        echo "- [ðŸ“Š EstatÃ­sticas](https://github.com/${{ github.repository }}/blob/main/.github/stats.json)" >> $GITHUB_STEP_SUMMARY

  # Job para validar links quebrados
  validate-links:
    runs-on: ubuntu-latest
    needs: update-readme
    if: always()
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ðŸ”— Check Links with lychee
      uses: lycheeverse/lychee-action@v1.8.0
      with:
        args: --verbose --no-progress --exclude-mail README.md
        fail: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: ðŸ“Š Link Check Summary
      run: |
        echo "## ðŸ”— RelatÃ³rio de Links" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ -f lychee/out.md ]; then
          cat lychee/out.md >> $GITHUB_STEP_SUMMARY
        else
          echo "âœ… Todos os links estÃ£o funcionando corretamente!" >> $GITHUB_STEP_SUMMARY
        fi